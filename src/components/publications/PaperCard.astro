---
import type { CollectionEntry } from "astro:content";

interface Props {
  paper: CollectionEntry<"publications">;
}

const { paper } = Astro.props;
const { data } = paper;

// Format authors with lab authors highlighted
const formatAuthors = (authors: string[], labAuthors?: string[]) => {
  return authors.map((author, i) => ({
    name: author,
    isLab:
      labAuthors?.some((la) =>
        author.toLowerCase().includes(la.toLowerCase())
      ) ?? false,
    isLast: i === authors.length - 1,
  }));
};

const authorList = formatAuthors(data.authors, data.labAuthors);

const typeLabels: Record<string, string> = {
  journal: "Journal",
  conference: "Conference",
  workshop: "Workshop",
  preprint: "Preprint",
  thesis: "Thesis",
  "book-chapter": "Book Chapter",
  patent: "Patent",
};

const googleScholarUrl = `https://scholar.google.com/scholar?q=${encodeURIComponent(data.title)}`;
---

<article
  class="card p-6 publication-card group hover:shadow-md transition-shadow duration-300 border border-gray-100 flex flex-col h-full bg-white cursor-pointer"
  onclick={`window.open('${googleScholarUrl}', '_blank')`}
  data-year={data.year}
  data-type={data.type}
  data-topics={data.topics?.join(",") || ""}
  data-title={data.title}
  data-authors={data.authors.join(",").toLowerCase()}
>
  <div class="flex justify-between items-start gap-4 mb-3">
    <span class="badge bg-primary-50 text-primary-700 border border-primary-100"
      >{typeLabels[data.type]}</span
    >
    {
      data.award && (
        <span class="badge bg-yellow-50 text-yellow-800 border border-yellow-100 flex items-center gap-1">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M10 2a1 1 0 011 1v1.323l3.954 1.582 1.699-3.181a1 1 0 011.827.89l-.598 6.095 4.318 1.916a1 1 0 11-.81 1.83l-4.318-1.917-2.904 4.09 1.488 4.295a1 1 0 01-1.905 1.163l-4.751-2.11-4.75 2.11a1 1 0 01-1.906-1.163l1.489-4.296-2.904-4.089-4.318 1.917a1 1 0 01-.81-1.83l4.318-1.916-.598-6.096a1 1 0 011.826-.89l1.699 3.18 3.953-1.581V3a1 1 0 011-1z"
              clip-rule="evenodd"
            />
          </svg>
          {data.award}
        </span>
      )
    }
  </div>

  <div class="grow">
    <h3
      class="text-xl font-semibold text-primary-900 mb-3 leading-tight group-hover:text-primary-700 transition-colors"
    >
      {data.title}
    </h3>

    <p class="text-sm text-gray-700 mb-4 leading-relaxed line-clamp-3">
      {
        authorList.map((author, i) => (
          <>
            <span class={author.isLab ? "font-semibold text-primary-800" : ""}>
              {author.name}
            </span>
            {!author.isLast && ", "}
          </>
        ))
      }
    </p>
  </div>

  <div class="mt-4 pt-4 border-t border-gray-50">
    <p class="text-sm text-gray-500 mb-4 flex items-start gap-2">
      <svg
        class="w-4 h-4 text-gray-400 mt-0.5 shrink-0"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
        ></path></svg
      >
      <span>
        <span class="font-medium text-gray-700"
          >{data.venueShort || data.venue}</span
        >
        {data.volume && `, Vol. ${data.volume}`}
        {data.pages && `, pp. ${data.pages}`}
        <span class="text-gray-400 mx-1">â€¢</span>
        {data.year}
      </span>
    </p>

    <div class="flex flex-wrap gap-2">
      {
        data.pdfUrl && (
          <a
            href={data.pdfUrl}
            target="_blank"
            rel="noopener noreferrer"
            onclick="event.stopPropagation()"
            class="inline-flex items-center gap-1.5 text-xs font-medium text-accent-600 hover:text-accent-700 bg-accent-50 px-3 py-1.5 rounded-full"
          >
            <svg
              class="w-3.5 h-3.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            PDF
          </a>
        )
      }
      {
        data.doi && (
          <a
            href={`https://doi.org/${data.doi}`}
            target="_blank"
            rel="noopener noreferrer"
            onclick="event.stopPropagation()"
            class="inline-flex items-center gap-1.5 text-xs font-medium text-gray-600 hover:text-gray-800 bg-gray-100 px-3 py-1.5 rounded-full"
          >
            DOI
          </a>
        )
      }
      {
        data.arxiv && (
          <a
            href={`https://arxiv.org/abs/${data.arxiv}`}
            target="_blank"
            rel="noopener noreferrer"
            onclick="event.stopPropagation()"
            class="inline-flex items-center gap-1.5 text-xs font-medium text-gray-600 hover:text-gray-800 bg-gray-100 px-3 py-1.5 rounded-full"
          >
            arXiv
          </a>
        )
      }
      {
        data.codeUrl && (
          <a
            href={data.codeUrl}
            target="_blank"
            rel="noopener noreferrer"
            onclick="event.stopPropagation()"
            class="inline-flex items-center gap-1.5 text-xs font-medium text-gray-600 hover:text-gray-800 bg-gray-100 px-3 py-1.5 rounded-full"
          >
            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" />
            </svg>
            Code
          </a>
        )
      }
    </div>
  </div>
</article>
